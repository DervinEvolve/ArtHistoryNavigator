{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4">
    <h1 class="text-3xl font-bold mb-8">Search</h1>
    <form id="search-form" class="mb-8">
        <input type="text" id="search-input" name="q" placeholder="Enter your search query" value="{{ query }}" class="w-full max-w-lg px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-600">
        <button type="submit" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-200">Search</button>
        <div class="mt-4">
            <label for="api-toggle" class="mr-2">Select API:</label>
            <select id="api-toggle" name="api" class="px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-600">
                <option value="openai">OpenAI</option>
                <option value="perplexity">Perplexity</option>
            </select>
        </div>
    </form>
    <div id="recommendations" class="mb-8">
        <h2 class="text-xl font-semibold mb-4">Recommended Searches:</h2>
        <div id="recommendation-list" class="flex flex-wrap gap-2"></div>
    </div>
    <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <!-- Results will be populated here -->
    </div>
    <div id="pagination-container" class="mt-8 flex justify-center"></div>
</div>

<script>
    document.getElementById('search-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const query = document.getElementById('search-input').value;
        const api = document.getElementById('api-toggle').value;
        searchAndDisplayResults(query, 1, api);
    });

    function searchAndDisplayResults(query, page, api) {
        fetch(`/api/search?q=${encodeURIComponent(query)}&page=${page}&api=${api}`)
            .then(response => response.json())
            .then(data => {
                displayResults(data.results);
                displayPagination(data.current_page, data.total_pages, query, api);
                displayRecommendations(data.recommendations, query);
            })
            .catch(error => console.error('Error:', error));
    }

    function displayResults(results) {
        const resultsContainer = document.getElementById('results-container');
        resultsContainer.innerHTML = '';
        for (const [source, sourceResults] of Object.entries(results)) {
            sourceResults.forEach(result => {
                const resultElement = document.createElement('div');
                resultElement.className = 'bg-white p-4 rounded-lg shadow';
                resultElement.innerHTML = `
                    <h2 class="text-xl font-semibold mb-2">${result.title}</h2>
                    <p class="text-gray-600 mb-2">${result.description || result.snippet || ''}</p>
                    <p class="text-sm text-gray-500">Source: ${source}</p>
                    ${result.url ? `<a href="${result.url}" target="_blank" class="text-blue-600 hover:underline">Read more</a>` : ''}
                `;
                resultsContainer.appendChild(resultElement);
            });
        }
    }

    function displayPagination(currentPage, totalPages, query, api) {
        const paginationContainer = document.getElementById('pagination-container');
        paginationContainer.innerHTML = '';
        for (let i = 1; i <= totalPages; i++) {
            const pageButton = document.createElement('button');
            pageButton.innerText = i;
            pageButton.className = i === currentPage ? 'mx-1 px-3 py-1 bg-blue-600 text-white rounded' : 'mx-1 px-3 py-1 bg-gray-200 rounded';
            pageButton.addEventListener('click', () => searchAndDisplayResults(query, i, api));
            paginationContainer.appendChild(pageButton);
        }
    }

    function displayRecommendations(recommendations, currentQuery) {
        const recommendationList = document.getElementById('recommendation-list');
        recommendationList.innerHTML = '';
        recommendations.forEach(rec => {
            const recButton = document.createElement('button');
            recButton.innerText = rec;
            recButton.className = 'px-3 py-1 bg-gray-200 rounded hover:bg-gray-300';
            recButton.addEventListener('click', () => {
                document.getElementById('search-input').value = rec;
                searchAndDisplayResults(rec, 1, document.getElementById('api-toggle').value);
            });
            recommendationList.appendChild(recButton);
        });
    }

    // Initial search if query is present
    const initialQuery = document.getElementById('search-input').value;
    if (initialQuery) {
        searchAndDisplayResults(initialQuery, 1, document.getElementById('api-toggle').value);
    }
</script>
{% endblock %}
