{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4">
    <h1 class="text-3xl font-bold mb-8">Search Results for "{{ query }}"</h1>
    <form action="/search" method="get" class="mb-8">
        <input type="text" name="q" value="{{ query }}" class="w-full max-w-lg px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-600">
        <button type="submit" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition duration-200">Search</button>
    </form>
    <div class="mb-4">
        <h3 class="text-xl font-semibold mb-2">Filter Results:</h3>
        <div class="flex flex-wrap">
            <button class="filter-btn active" data-source="wikipedia">
                <span class="icon wikipedia-icon"></span>Wikipedia
            </button>
            <button class="filter-btn active" data-source="internet_archive">
                <span class="icon internet-archive-icon"></span>Internet Archive
            </button>
            <button class="filter-btn active" data-source="met_museum">
                <span class="icon met-museum-icon"></span>Met Museum
            </button>
            <button class="filter-btn active" data-source="rijksmuseum">
                <span class="icon rijksmuseum-icon"></span>Rijksmuseum
            </button>
            <button class="filter-btn active" data-source="harvard_art_museums">
                <span class="icon harvard-art-museums-icon"></span>Harvard Art Museums
            </button>
            <button class="filter-btn active" data-source="cooper_hewitt">
                <span class="icon cooper-hewitt-icon"></span>Cooper Hewitt
            </button>
        </div>
    </div>
    <div class="flex flex-col md:flex-row">
        <aside class="w-full md:w-1/4 pr-4 mb-8 md:mb-0">
            <div class="sidebar">
                <h3>Search History</h3>
                <ul id="search-history" class="search-history">
                    <!-- Search history will be populated here -->
                </ul>
            </div>
        </aside>
        <main class="w-full md:w-3/4">
            <div id="no-results" class="hidden text-center text-gray-600 text-xl mb-8">
                No results found for your query. Please try a different search term.
            </div>
            <div id="search-results" class="search-results-container">
                <!-- Results will be populated here -->
            </div>
            <div id="loading-indicator" class="hidden text-center py-4">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
                <p class="mt-2">Loading more results...</p>
            </div>
        </main>
    </div>
</div>

<button id="back-to-top" class="fixed bottom-4 right-4 bg-blue-600 text-white p-2 rounded-full shadow-md hidden">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
    </svg>
</button>

<div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div id="modal-content" class="max-h-[70vh] overflow-y-auto"></div>
        <div class="text-right mt-4">
            <button id="close-modal" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-700">Close</button>
        </div>
    </div>
</div>

<div id="collections-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <h2 class="text-2xl font-bold mb-4">Add to Collection</h2>
        <div id="collections-list" class="mb-4">
            <!-- Collections will be populated here -->
        </div>
        <div class="text-right mt-4">
            <button id="close-collections-modal" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-700">Close</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function createResultHTML(result, source) {
        let iconClass = `${source}-icon`;
        let cardContent = '';
        let buttonHtml = '';
        let modalContent = '';

        if (source === 'wikipedia') {
            cardContent = `<p>${result.snippet}</p>`;
            buttonHtml = `<a href="${result.url}" target="_blank" class="inline-block mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors duration-200">Read More</a>`;
            modalContent = JSON.stringify(result);
        } else if (source === 'internet_archive') {
            cardContent = `
                <p>${result.description}</p>
                <p class="text-sm text-gray-600">Format: ${result.format}</p>
            `;
            buttonHtml = `<a href="${result.url}" target="_blank" class="inline-block mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors duration-200">View Item</a>`;
            modalContent = JSON.stringify(result);
        } else if (source === 'met_museum' || source === 'rijksmuseum' || source === 'harvard_art_museums' || source === 'cooper_hewitt') {
            cardContent = `
                <img src="${result.image_url}" alt="${result.title}" class="w-full h-48 object-cover mb-2">
                <p>${result.description}</p>
                <p class="text-sm text-gray-600">${result.date}</p>
            `;
            buttonHtml = `<button class="view-details mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-colors duration-200" data-source="${source}" data-id="${result.id}">View Details</button>`;
            modalContent = JSON.stringify(result);
        }

        const addToCollectionButton = `<button class="add-to-collection-btn bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition-colors duration-200 mt-2" data-source="${source}" data-content='${modalContent}'>Add to Collection</button>`;

        const cardHtml = `
            <div class="search-result-card bg-white rounded-lg shadow-md overflow-hidden fade-in" data-source="${source}">
                <div class="flex items-center mb-2">
                    <span class="icon ${iconClass} mr-2"></span>
                    <h3 class="text-lg font-semibold">${result.title || 'No title'}</h3>
                </div>
                ${cardContent}
                ${buttonHtml}
                ${addToCollectionButton}
            </div>
        `;

        return cardHtml;
    }

    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('add-to-collection-btn')) {
            const source = e.target.dataset.source;
            const content = e.target.dataset.content;
            showCollectionsModal(source, content);
        }
    });

    function showCollectionsModal(source, content) {
        const collectionsModal = document.getElementById('collections-modal');
        const collectionsList = document.getElementById('collections-list');
        
        // Fetch user's collections
        fetch('/collections')
            .then(response => response.json())
            .then(collections => {
                collectionsList.innerHTML = collections.map(collection => `
                    <div class="mb-2">
                        <button class="add-to-collection px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" data-collection-id="${collection.id}" data-source="${source}" data-content='${content}'>
                            ${collection.title}
                        </button>
                    </div>
                `).join('');
            });

        collectionsModal.classList.remove('hidden');
    }

    document.getElementById('close-collections-modal').addEventListener('click', function() {
        document.getElementById('collections-modal').classList.add('hidden');
    });

    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('add-to-collection')) {
            const collectionId = e.target.dataset.collectionId;
            const source = e.target.dataset.source;
            const content = e.target.dataset.content;

            // Add item to collection
            fetch(`/add_to_collection/${collectionId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ source: source, content: content }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    document.getElementById('collections-modal').classList.add('hidden');
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });
</script>
{% endblock %}